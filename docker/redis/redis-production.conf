# ================================
# Redis Production Configuration
# ================================
# Optimized for production workloads with security, persistence,
# and performance tuning for SightEdit caching needs

# ================================
# Network and Basic Settings
# ================================
bind 0.0.0.0
port 6379
tcp-backlog 511
timeout 300
tcp-keepalive 300

# ================================
# Security Configuration
# ================================
# Require password authentication
requirepass CHANGE_THIS_REDIS_PASSWORD_IN_PRODUCTION

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command EVAL ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_b835e2c9"
rename-command SHUTDOWN "SHUTDOWN_a78c0e5f"

# Enable protected mode
protected-mode yes

# ================================
# Memory Management
# ================================
# Maximum memory usage (adjust based on available RAM)
maxmemory 2gb

# Memory eviction policy for cache use case
maxmemory-policy allkeys-lru

# Memory sampling for eviction
maxmemory-samples 5

# ================================
# Persistence Configuration
# ================================
# RDB (snapshots) configuration
save 900 1     # Save if at least 1 key changed in 900 seconds
save 300 10    # Save if at least 10 keys changed in 300 seconds
save 60 10000  # Save if at least 10000 keys changed in 60 seconds

# RDB file settings
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# AOF (Append Only File) configuration for durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# ================================
# Logging Configuration
# ================================
loglevel notice
logfile /var/log/redis/redis-server.log
syslog-enabled yes
syslog-ident redis
syslog-facility local0

# ================================
# Client Connection Management
# ================================
# Maximum number of connected clients
maxclients 10000

# Client timeout
timeout 300

# ================================
# Performance Tuning
# ================================
# Disable transparent huge pages warning
# (should be set at OS level: echo never > /sys/kernel/mm/transparent_hugepage/enabled)

# Hash table rehashing
hz 10

# Lazy freeing (non-blocking deletion)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# Background saving and rewriting
rdb-save-incremental-fsync yes

# ================================
# Slow Log Configuration
# ================================
slowlog-log-slower-than 10000  # Log queries slower than 10ms
slowlog-max-len 128

# ================================
# Advanced Configuration
# ================================
# Hash table settings
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List settings
list-max-ziplist-size -2
list-compress-depth 0

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog settings
hll-sparse-max-bytes 3000

# ================================
# Keyspace Notifications
# ================================
# Enable keyspace notifications for cache invalidation
notify-keyspace-events "Ex"

# ================================
# Replication Configuration (if using Redis replicas)
# ================================
# Uncomment and configure these if setting up replication
# replicaof <masterip> <masterport>
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5
# repl-ping-replica-period 10
# repl-timeout 60
# repl-disable-tcp-nodelay no
# replica-priority 100

# ================================
# Sentinel Configuration (if using Redis Sentinel)
# ================================
# This would be in a separate sentinel.conf file
# sentinel monitor mymaster 127.0.0.1 6379 2
# sentinel down-after-milliseconds mymaster 60000
# sentinel failover-timeout mymaster 180000
# sentinel parallel-syncs mymaster 1

# ================================
# Cluster Configuration (if using Redis Cluster)
# ================================
# cluster-enabled yes
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000
# cluster-require-full-coverage yes

# ================================
# Memory Usage Optimization
# ================================
# Optimize for memory usage
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# ================================
# TLS/SSL Configuration (if using SSL)
# ================================
# Uncomment and configure if using TLS
# port 0
# tls-port 6380
# tls-cert-file /etc/ssl/certs/redis.crt
# tls-key-file /etc/ssl/private/redis.key
# tls-ca-cert-file /etc/ssl/certs/ca.crt
# tls-dh-params-file /etc/ssl/certs/redis.dh
# tls-protocols "TLSv1.2 TLSv1.3"
# tls-ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256"
# tls-ciphersuites "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
# tls-prefer-server-ciphers yes

# ================================
# Monitoring and Metrics
# ================================
# Enable latency monitoring
latency-monitor-threshold 100

# ================================
# Modules (if using Redis modules)
# ================================
# loadmodule /path/to/module.so

# ================================
# Custom Configuration for SightEdit
# ================================
# Database selection (use different databases for different purposes)
# Database 0: User sessions and authentication
# Database 1: Page content cache
# Database 2: API response cache
# Database 3: File upload metadata
# Database 4: Real-time collaboration data

databases 16